-- Query de Despesa Orçamentária
-- Extrai dados de execução orçamentária com informações detalhadas
-- Autor: Sistema de Balanço Geral DF
-- Data: 2024

SELECT 
    T1.COCONTACORRENTE,
    T1.CONATUREZA,
    SUBSTR(T1.CONATUREZA, 1, 1) AS CATEGORIA, 
    T2.NOCATEGORIA,
    SUBSTR(T1.CONATUREZA, 2, 1) AS GRUPO, 
    T3.NOGRUPO,
    SUBSTR(T1.CONATUREZA, 3, 2) AS MODALIDADE, 
    T4.NOMODALIDADE,
    SUBSTR(T1.CONATUREZA, 5, 2) AS ELEMENTO, 
    T5.NOELEMENTO,
    COEXERCICIO,
    INMES,  
    SUM(CASE WHEN T1.COCONTACONTABIL BETWEEN 522110000 AND 522119999 THEN T1.VADEBITO - T1.VACREDITO ELSE 0 END) AS DOTACAO_INICIAL,
    SUM(CASE WHEN T1.COCONTACONTABIL BETWEEN 522120000 AND 522129999 THEN T1.VADEBITO - T1.VACREDITO ELSE 0 END) AS DOTACAO_ADICIONAL,
    SUM(CASE WHEN T1.COCONTACONTABIL BETWEEN 522150000 AND 522159999 THEN T1.VADEBITO - T1.VACREDITO ELSE 0 END) AS CANCELAMENTO_DOTACAO,
    SUM(CASE WHEN T1.COCONTACONTABIL BETWEEN 522190000 AND 522199999 THEN T1.VADEBITO - T1.VACREDITO ELSE 0 END) AS CANCEL_REMANEJA_DOTACAO,
    SUM(CASE WHEN T1.COCONTACONTABIL BETWEEN 622130000 AND 622139999 THEN T1.VACREDITO - T1.VADEBITO ELSE 0 END) AS DESPESA_EMPENHADA,
    SUM(CASE WHEN T1.COCONTACONTABIL IN (622130300, 622130400, 622130700) THEN T1.VACREDITO - T1.VADEBITO ELSE 0 END) AS DESPESA_LIQUIDADA,
    SUM(CASE WHEN T1.COCONTACONTABIL IN (622920104) THEN T1.VACREDITO - T1.VADEBITO ELSE 0 END) AS DESPESA_PAGA,
    SUM(CASE WHEN T1.COCONTACONTABIL IN (622130600) THEN T1.VACREDITO - T1.VADEBITO ELSE 0 END) AS SALDO_DOTACAO,
    T1.COFUNCAO,
    T1.COSUBFUNCAO,
    T1.COPROGRAMA,
    T1.COPROJETO,
    T1.COSUBTITULO,
    T1.INESFERA,
    T1.COFONTE,
    T1.COUG, 
    T1.COGESTAO,
    T6.INTIPOADM,
    T7.NOUG
FROM 
    MIL2001.SALDOCONTABIL_EX T1
    LEFT JOIN MIL2025.VCATEGORIA T2 ON SUBSTR(T1.CONATUREZA,1,1) = TO_CHAR(T2.INCATEGORIA)
    LEFT JOIN MIL2025.VGRUPO T3 ON SUBSTR(T1.CONATUREZA,2,1) = TO_CHAR(T3.COGRUPO)
    LEFT JOIN MIL2025.VMODALIDADE T4 ON SUBSTR(T1.CONATUREZA,3,2) = TO_CHAR(T4.COMODALIDADE)
    LEFT JOIN MIL2025.VELEMENTO T5 ON TO_NUMBER(SUBSTR(T1.CONATUREZA, 5, 2)) = T5.COELEMENTO
    LEFT JOIN MIL2025.UNIDADEGESTORA T7 ON T1.COUG = T7.COUG
    LEFT JOIN MIL2025.GESTAO T6 ON T1.COGESTAO = T6.COGESTAO
WHERE 
    (
        T1.COCONTACONTABIL BETWEEN 522110000 AND 522119999 OR
        T1.COCONTACONTABIL BETWEEN 522120000 AND 522129999 OR
        T1.COCONTACONTABIL BETWEEN 522150000 AND 522159999 OR
        T1.COCONTACONTABIL BETWEEN 522190000 AND 522199999 OR
        T1.COCONTACONTABIL BETWEEN 622130000 AND 622139999 OR
        T1.COCONTACONTABIL IN (622130300, 622130400, 622130700, 622920104, 622130600)
    )
    AND COEXERCICIO IN (:exercicio_inicial, :exercicio_final)  -- Parâmetros
    AND INMES <= :mes_limite                                     -- Parâmetro
GROUP BY 
    T1.COCONTACORRENTE,
    T1.CONATUREZA,
    T1.COUG, 
    T1.COGESTAO,
    T7.NOUG,
    T1.COEXERCICIO,
    T1.INMES,
    T1.COFUNCAO,
    T1.COSUBFUNCAO,
    T1.COPROGRAMA,
    T1.COPROJETO,
    T1.COSUBTITULO,
    T1.INESFERA,
    T1.COFONTE,
    T6.INTIPOADM,
    SUBSTR(T1.COCONTACORRENTE,-6,1),
    SUBSTR(T1.COCONTACORRENTE,-5,1),
    SUBSTR(T1.COCONTACORRENTE,-4,2),
    SUBSTR(T1.COCONTACORRENTE,-2,2),
    T2.NOCATEGORIA,
    T3.NOGRUPO,
    T4.NOMODALIDADE,
    T5.NOELEMENTO
ORDER BY 
    COEXERCICIO,
    INMES